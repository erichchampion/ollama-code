<?xml version="1.0" encoding="UTF-8"?><xsl:stylesheet xmlns:dita-ot="http://dita-ot.sourceforge.net/ns/201007/dita-ot" xmlns:ditaarch="http://dita.oasis-open.org/architecture/2005/" xmlns:e="pdf-theme" xmlns:fo="http://www.w3.org/1999/XSL/Format" xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" xmlns:opentopic-func="http://www.idiominc.com/opentopic/exsl/function" xmlns:opentopic="http://www.idiominc.com/opentopic" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="2.0" exclude-result-prefixes="xs e dita-ot ditaarch opentopic opentopic-func"><xsl:template match="*[contains(@class, ' bookmap/appendix ')]" mode="tocText"><xsl:param name="tocItemContent"/><xsl:param name="currentNode"/><xsl:for-each select="$currentNode"><fo:block xsl:use-attribute-sets="__toc__appendix__content"><xsl:copy-of select="$tocItemContent"/></fo:block></xsl:for-each></xsl:template><xsl:template match="*[contains(@class, ' bookmap/part ')]" mode="tocText"><xsl:param name="tocItemContent"/><xsl:param name="currentNode"/><xsl:for-each select="$currentNode"><fo:block xsl:use-attribute-sets="__toc__part__content"><xsl:copy-of select="$tocItemContent"/></fo:block></xsl:for-each></xsl:template><xsl:template match="*[contains(@class, ' bookmap/preface ')]" mode="tocText"><xsl:param name="tocItemContent"/><xsl:param name="currentNode"/><xsl:for-each select="$currentNode"><fo:block xsl:use-attribute-sets="__toc__preface__content"><xsl:copy-of select="$tocItemContent"/></fo:block></xsl:for-each></xsl:template><xsl:template match="*[contains(@class, ' bookmap/notices ')]" mode="tocText"><xsl:param name="tocItemContent"/><xsl:param name="currentNode"/><xsl:for-each select="$currentNode"><fo:block xsl:use-attribute-sets="__toc__notices__content"><xsl:copy-of select="$tocItemContent"/></fo:block></xsl:for-each></xsl:template><xsl:template match="node()" mode="tocText" priority="-10"><xsl:param name="tocItemContent"/><xsl:param name="currentNode"/><xsl:param name="prefix" select="''" as="xs:string?"/><xsl:for-each select="$currentNode"><xsl:variable name="topicref" select="key('map-id', @id)"/><xsl:variable name="level" as="xs:integer"><xsl:apply-templates select="." mode="get-topic-level"/></xsl:variable><xsl:choose><xsl:when test="true()"><fo:block xsl:use-attribute-sets="__toc__topic__content"><xsl:copy-of select="$tocItemContent"/></fo:block></xsl:when></xsl:choose></xsl:for-each></xsl:template><xsl:template match="*[contains(@class, ' map/topicref ')]" mode="tocPrefix"><xsl:sequence select="e:get-title-number(key('topic-id', @id))"/><xsl:text> </xsl:text></xsl:template><xsl:variable name="e:partTocMaximumLevel" select="7"/><xsl:template match="node()" mode="part-toc"><xsl:param name="include"/><xsl:apply-templates mode="#current"><xsl:with-param name="include" select="$include"/></xsl:apply-templates></xsl:template><xsl:template match="*[contains(@class, ' topic/topic ')]" mode="part-toc"><xsl:param name="include"/><xsl:variable name="topicLevel" as="xs:integer"><xsl:apply-templates select="." mode="get-topic-level"/></xsl:variable><xsl:if test="$topicLevel &lt; $e:partTocMaximumLevel"><xsl:variable name="mapTopicref" select="key('map-id', @id)[1]" as="element()?"/><xsl:choose><xsl:when test="$mapTopicref[@toc = 'yes' or not(@toc)] or                                 (not($mapTopicref) and $include = 'true')"><fo:block xsl:use-attribute-sets="__toc__indent__part"><xsl:variable name="tocItemContent"><fo:basic-link xsl:use-attribute-sets="__toc__link"><xsl:attribute name="internal-destination"><xsl:call-template name="generate-toc-id"/></xsl:attribute><xsl:attribute name="fox:alt-text"><xsl:call-template name="getNavTitle"/></xsl:attribute><xsl:apply-templates select="*[contains(@class,' ditaot-d/ditaval-startprop ')]/revprop[@changebar]" mode="changebar"><xsl:with-param name="changebar-id" select="concat(dita-ot:generate-changebar-id(.),'-toc')"/></xsl:apply-templates><xsl:apply-templates select="$mapTopicref" mode="tocPrefix"/><fo:inline xsl:use-attribute-sets="__toc__title"><xsl:variable name="pulledNavigationTitle" as="item()*"><xsl:call-template name="getNavTitle"/></xsl:variable><xsl:apply-templates select="$pulledNavigationTitle" mode="dropCopiedIds"/></fo:inline><xsl:apply-templates select="*[contains(@class,' ditaot-d/ditaval-endprop ')]/revprop[@changebar]" mode="changebar"><xsl:with-param name="changebar-id" select="concat(dita-ot:generate-changebar-id(.),'-toc')"/></xsl:apply-templates><fo:inline xsl:use-attribute-sets="__toc__page-number"><fo:leader xsl:use-attribute-sets="__toc__leader"/><fo:page-number-citation><xsl:attribute name="ref-id"><xsl:call-template name="generate-toc-id"/></xsl:attribute></fo:page-number-citation></fo:inline></fo:basic-link></xsl:variable><xsl:choose><xsl:when test="not($mapTopicref)"><xsl:apply-templates select="." mode="tocText"><xsl:with-param name="tocItemContent" select="$tocItemContent"/><xsl:with-param name="currentNode" select="."/><xsl:with-param name="prefix" select="'part'"/></xsl:apply-templates></xsl:when><xsl:otherwise><xsl:apply-templates select="$mapTopicref" mode="tocText"><xsl:with-param name="tocItemContent" select="$tocItemContent"/><xsl:with-param name="currentNode" select="."/><xsl:with-param name="prefix" select="'part'"/></xsl:apply-templates></xsl:otherwise></xsl:choose></fo:block><xsl:apply-templates mode="#current"><xsl:with-param name="include" select="'true'"/></xsl:apply-templates></xsl:when><xsl:otherwise><xsl:apply-templates mode="#current"><xsl:with-param name="include" select="'true'"/></xsl:apply-templates></xsl:otherwise></xsl:choose></xsl:if></xsl:template><xsl:variable name="e:chapterTocMaximumLevel" select="8"/><xsl:template match="node()" mode="chapter-toc"><xsl:param name="include"/><xsl:apply-templates mode="#current"><xsl:with-param name="include" select="$include"/></xsl:apply-templates></xsl:template><xsl:template match="*[contains(@class, ' topic/topic ')]" mode="chapter-toc"><xsl:param name="include"/><xsl:variable name="topicLevel" as="xs:integer"><xsl:apply-templates select="." mode="get-topic-level"/></xsl:variable><xsl:if test="$topicLevel &lt; $e:chapterTocMaximumLevel"><xsl:variable name="mapTopicref" select="key('map-id', @id)[1]" as="element()?"/><xsl:choose><xsl:when test="$mapTopicref[@toc = 'yes' or not(@toc)] or                                 (not($mapTopicref) and $include = 'true')"><fo:block xsl:use-attribute-sets="__toc__indent__chapter"><xsl:variable name="tocItemContent"><fo:basic-link xsl:use-attribute-sets="__toc__link"><xsl:attribute name="internal-destination"><xsl:call-template name="generate-toc-id"/></xsl:attribute><xsl:attribute name="fox:alt-text"><xsl:call-template name="getNavTitle"/></xsl:attribute><xsl:apply-templates select="*[contains(@class,' ditaot-d/ditaval-startprop ')]/revprop[@changebar]" mode="changebar"><xsl:with-param name="changebar-id" select="concat(dita-ot:generate-changebar-id(.),'-toc')"/></xsl:apply-templates><xsl:apply-templates select="$mapTopicref" mode="tocPrefix"/><fo:inline xsl:use-attribute-sets="__toc__title"><xsl:variable name="pulledNavigationTitle" as="item()*"><xsl:call-template name="getNavTitle"/></xsl:variable><xsl:apply-templates select="$pulledNavigationTitle" mode="dropCopiedIds"/></fo:inline><xsl:apply-templates select="*[contains(@class,' ditaot-d/ditaval-endprop ')]/revprop[@changebar]" mode="changebar"><xsl:with-param name="changebar-id" select="concat(dita-ot:generate-changebar-id(.),'-toc')"/></xsl:apply-templates><fo:inline xsl:use-attribute-sets="__toc__page-number"><fo:leader xsl:use-attribute-sets="__toc__leader"/><fo:page-number-citation><xsl:attribute name="ref-id"><xsl:call-template name="generate-toc-id"/></xsl:attribute></fo:page-number-citation></fo:inline></fo:basic-link></xsl:variable><xsl:choose><xsl:when test="not($mapTopicref)"><xsl:apply-templates select="." mode="tocText"><xsl:with-param name="tocItemContent" select="$tocItemContent"/><xsl:with-param name="currentNode" select="."/><xsl:with-param name="prefix" select="'chapter'"/></xsl:apply-templates></xsl:when><xsl:otherwise><xsl:apply-templates select="$mapTopicref" mode="tocText"><xsl:with-param name="tocItemContent" select="$tocItemContent"/><xsl:with-param name="currentNode" select="."/><xsl:with-param name="prefix" select="'chapter'"/></xsl:apply-templates></xsl:otherwise></xsl:choose></fo:block><xsl:apply-templates mode="#current"><xsl:with-param name="include" select="'true'"/></xsl:apply-templates></xsl:when><xsl:otherwise><xsl:apply-templates mode="#current"><xsl:with-param name="include" select="'true'"/></xsl:apply-templates></xsl:otherwise></xsl:choose></xsl:if></xsl:template><xsl:variable name="e:appendixTocMaximumLevel" select="8"/><xsl:template match="node()" mode="appendix-toc"><xsl:param name="include"/><xsl:apply-templates mode="#current"><xsl:with-param name="include" select="$include"/></xsl:apply-templates></xsl:template><xsl:template match="*[contains(@class, ' topic/topic ')]" mode="appendix-toc"><xsl:param name="include"/><xsl:variable name="topicLevel" as="xs:integer"><xsl:apply-templates select="." mode="get-topic-level"/></xsl:variable><xsl:if test="$topicLevel &lt; $e:appendixTocMaximumLevel"><xsl:variable name="mapTopicref" select="key('map-id', @id)[1]" as="element()?"/><xsl:choose><xsl:when test="$mapTopicref[@toc = 'yes' or not(@toc)] or                                 (not($mapTopicref) and $include = 'true')"><fo:block xsl:use-attribute-sets="__toc__indent__appendix"><xsl:variable name="tocItemContent"><fo:basic-link xsl:use-attribute-sets="__toc__link"><xsl:attribute name="internal-destination"><xsl:call-template name="generate-toc-id"/></xsl:attribute><xsl:attribute name="fox:alt-text"><xsl:call-template name="getNavTitle"/></xsl:attribute><xsl:apply-templates select="*[contains(@class,' ditaot-d/ditaval-startprop ')]/revprop[@changebar]" mode="changebar"><xsl:with-param name="changebar-id" select="concat(dita-ot:generate-changebar-id(.),'-toc')"/></xsl:apply-templates><xsl:apply-templates select="$mapTopicref" mode="tocPrefix"/><fo:inline xsl:use-attribute-sets="__toc__title"><xsl:variable name="pulledNavigationTitle" as="item()*"><xsl:call-template name="getNavTitle"/></xsl:variable><xsl:apply-templates select="$pulledNavigationTitle" mode="dropCopiedIds"/></fo:inline><xsl:apply-templates select="*[contains(@class,' ditaot-d/ditaval-endprop ')]/revprop[@changebar]" mode="changebar"><xsl:with-param name="changebar-id" select="concat(dita-ot:generate-changebar-id(.),'-toc')"/></xsl:apply-templates><fo:inline xsl:use-attribute-sets="__toc__page-number"><fo:leader xsl:use-attribute-sets="__toc__leader"/><fo:page-number-citation><xsl:attribute name="ref-id"><xsl:call-template name="generate-toc-id"/></xsl:attribute></fo:page-number-citation></fo:inline></fo:basic-link></xsl:variable><xsl:choose><xsl:when test="not($mapTopicref)"><xsl:apply-templates select="." mode="tocText"><xsl:with-param name="tocItemContent" select="$tocItemContent"/><xsl:with-param name="currentNode" select="."/><xsl:with-param name="prefix" select="'appendix'"/></xsl:apply-templates></xsl:when><xsl:otherwise><xsl:apply-templates select="$mapTopicref" mode="tocText"><xsl:with-param name="tocItemContent" select="$tocItemContent"/><xsl:with-param name="currentNode" select="."/><xsl:with-param name="prefix" select="'appendix'"/></xsl:apply-templates></xsl:otherwise></xsl:choose></fo:block><xsl:apply-templates mode="#current"><xsl:with-param name="include" select="'true'"/></xsl:apply-templates></xsl:when><xsl:otherwise><xsl:apply-templates mode="#current"><xsl:with-param name="include" select="'true'"/></xsl:apply-templates></xsl:otherwise></xsl:choose></xsl:if></xsl:template></xsl:stylesheet>